name: Regenerate Linux Constraints

on:
  workflow_dispatch:

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Pin packaging stack (pip <25 + pip-tools 7.4.x)
        run: |
          python -m pip install --upgrade "pip<25" "pip-tools>=7.4,<7.5" build

      - name: Regenerate constraints (Linux, py312)
        run: |
          mkdir -p constraints
          cat > constraints/linux-extra.in << 'EOF'
          # ensure linux-only keyring deps are pinned with hashes
          secretstorage
          jeepney
          EOF

          pip-compile \
            --generate-hashes \
            --resolver=backtracking \
            --strip-extras \
            --output-file constraints/runtime-linux-py312.txt \
            pyproject.toml constraints/linux-extra.in
      
      - name: Show diff
        run: git --no-pager diff --color -- constraints/runtime-linux-py312.txt || true
      
      - name: Verify SecretStorage and jeepney are included
        run: |
          grep -iq '^secretstorage==' constraints/runtime-linux-py312.txt
          grep -iq '^jeepney=='       constraints/runtime-linux-py312.txt

      - name: Verify pins have hashes
        run: |
          python - <<'PY'
          import pathlib, sys
          p = pathlib.Path("constraints/runtime-linux-py312.txt")
          t = [ln.rstrip().lower() for ln in p.read_text().splitlines()]
          def check(pkg: str):
              i = next((k for k,ln in enumerate(t) if ln.startswith(f"{pkg}==")), None)
              if i is None:
                  print(f"missing pin: {pkg}", file=sys.stderr); sys.exit(1)
              j = i + 1
              found = False
              while j < len(t):
                  ln = t[j].lstrip()
                  if ln.startswith("--hash="):
                      found = True; break
                  if ln and not ln.startswith(("#","--hash=")):
                      break   # next requirement reached
                  j += 1
              if not found:
                  print(f"missing --hash lines for {pkg}", file=sys.stderr); sys.exit(1)
          for pkg in ("secretstorage", "jeepney"):
              check(pkg)
          print("âœ… Both SecretStorage and jeepney are properly pinned with hashes")
          PY
      
      - name: Show diff
        run: |
          echo "=== Generated constraints file ==="
          head -20 constraints/runtime-linux-py312.txt
          echo "..."
          tail -10 constraints/runtime-linux-py312.txt
      
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: regenerate linux constraints (py312, manylinux_2_28)"
          file_pattern: constraints/runtime-linux-py312.txt
